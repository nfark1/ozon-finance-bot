import os
import sys
import nest_asyncio
import pandas as pd
from io import BytesIO
from telegram import Update, InputFile
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, ContextTypes, filters

sku_costs = {
    "–§–°–û_MAX_2": 215,
    "–§–°–û_MAX_4": 415,
    "FARA_NIVA_2": 1060,
}

sku_names = {
    "–§–°–û_MAX_2": "üì¶ –§–°–û_MAX_2",
    "–§–°–û_MAX_4": "üì¶ –§–°–û_MAX_4",
    "FARA_NIVA_2": "üì¶ FARA_NIVA_2"
}

expense_labels = {
    "–ë–æ–Ω—É—Å—ã –ø—Ä–æ–¥–∞–≤—Ü–∞": "üéÅ –ë–æ–Ω—É—Å—ã –ø—Ä–æ–¥–∞–≤—Ü–∞",
    "–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –ø—Ä–æ–¥–∞–∂—É": "üíº –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –ø—Ä–æ–¥–∞–∂—É",
    "–õ–æ–≥–∏—Å—Ç–∏–∫–∞": "üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞",
    "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å –æ–ø–ª–∞—Ç–æ–π –∑–∞ –∑–∞–∫–∞–∑": "üì¢ –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ (–æ–ø–ª–∞—Ç–∞ –∑–∞ –∑–∞–∫–∞–∑)",
    "–≠–∫–≤–∞–π—Ä–∏–Ω–≥": "üí≥ –≠–∫–≤–∞–π—Ä–∏–Ω–≥"
}

def format_rub(value):
    return f"{value:,.2f} ‚ÇΩ".replace(",", "‚ÄØ")

def extract_report(file_path):
    df = pd.read_excel(file_path, header=None)
    for i in range(10):
        if "–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è" in df.iloc[i].astype(str).values:
            df = pd.read_excel(file_path, header=i)
            break
    else:
        return "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏."

    df.columns = df.columns.str.strip()
    df = df[df["–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"].str.lower() != " "]
    df["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"] = pd.to_numeric(df["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"], errors="coerce").fillna(0)
    df["–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞"] = pd.to_numeric(df["–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞"], errors="coerce").fillna(0)
    df["–°—É–º–º–∞ –∏—Ç–æ–≥–æ, —Ä—É–±"] = pd.to_numeric(df["–°—É–º–º–∞ –∏—Ç–æ–≥–æ, —Ä—É–±"], errors="coerce").fillna(0)

    sales = df[df["–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"].str.lower() == "–≤—ã—Ä—É—á–∫–∞"].copy()
    sales["–°—É–º–º–∞"] = sales["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"] * sales["–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞"]
    total_revenue = sales["–°—É–º–º–∞"].sum()

    sku_column = next((col for col in df.columns if any(k in col.lower() for k in ["–∞—Ä—Ç–∏–∫—É–ª", "sku", "–æ–±—ä—è–≤–ª–µ–Ω–∏–µ"])), None)
    if not sku_column:
        return "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ —Å –∞—Ä—Ç–∏–∫—É–ª–∞–º–∏ —Ç–æ–≤–∞—Ä–∞."
    qty_by_sku = sales.groupby(sku_column)["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"].sum().to_dict()
    cost_by_sku = {sku: qty_by_sku.get(sku, 0) * cost for sku, cost in sku_costs.items()}
    total_cost = sum(cost_by_sku.values())

    expenses = df[~df["–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"].str.lower().isin(["–≤—ã—Ä—É—á–∫–∞"])]
    expenses = expenses[~expenses["–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"].str.lower().str.contains("–±–∞–ª–ª—ã")]
    expenses_sum = expenses.groupby("–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è")["–°—É–º–º–∞ –∏—Ç–æ–≥–æ, —Ä—É–±"].sum().abs().to_dict()
    total_expenses = sum(expenses_sum.values())

    tax = total_revenue * 0.04
    net_profit = total_revenue - total_cost - total_expenses - tax
    gross_margin = (total_revenue - total_cost) / total_revenue * 100 if total_revenue else 0
    net_margin = net_profit / total_revenue * 100 if total_revenue else 0
    total_qty = sum(qty_by_sku.values())
    avg_check = total_revenue / total_qty if total_qty else 0

    filename = os.path.basename(file_path)
    lines = [f"üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ: {filename}\n"]
    lines.append(f"üí∞ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞: {format_rub(total_revenue)}")
    lines.append(f"üßæ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: {format_rub(total_cost)}")
    for sku in sku_costs:
        sku_name = sku_names.get(sku, sku)
        lines.append(f"   ‚îú‚îÄ {sku_name}: {format_rub(cost_by_sku.get(sku, 0))}")
    lines[-1] = lines[-1].replace("‚îú‚îÄ", "‚îî‚îÄ")

    lines.append(f"\nüí∏ –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã: {format_rub(total_expenses)}")
    keys = list(expenses_sum.keys())
    for i, key in enumerate(keys):
        label = expense_labels.get(key, f"‚ñ´Ô∏è {key}")
        prefix = "‚îî‚îÄ" if i == len(keys)-1 else "‚îú‚îÄ"
        lines.append(f"   {prefix} {label}: {format_rub(expenses_sum[key])}")

    lines += [
        f"\nüìâ –ù–∞–ª–æ–≥ –ø–æ –£–°–ù (4%): {format_rub(tax)}",
        f"\nüü¢ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: {format_rub(net_profit)}\n",
        f"üßÆ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂: {int(total_qty)} —à—Ç."
    ]
    for sku in sku_costs:
        sku_name = sku_names.get(sku, sku)
        lines.append(f"   ‚îú‚îÄ {sku_name}: {int(qty_by_sku.get(sku, 0))} —à—Ç.")
    lines[-1] = lines[-1].replace("‚îú‚îÄ", "‚îî‚îÄ")
    lines += [
        f"\nüí≥ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {format_rub(avg_check)}",
        f"üìà –í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞: {gross_margin:.2f}%",
        f"üìä –ß–∏—Å—Ç–∞—è –º–∞—Ä–∂–∞: {net_margin:.2f}%"
    ]
    return "\n".join(lines)

async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file = update.message.document
    if not file.file_name.endswith(".xlsx"):
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ Excel .xlsx —Ñ–∞–π–ª—ã.")
        return
    file_path = f"temp_{file.file_name}"
    new_file = await context.bot.get_file(file.file_id)
    await new_file.download_to_drive(file_path)
    text = extract_report(file_path)
    os.remove(file_path)
    await update.message.reply_text("üìé –í–∞—à –æ—Ç—á—ë—Ç –≥–æ—Ç–æ–≤! –°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –±–æ—Ç–æ–º üôå")
    with BytesIO(text.encode("utf-8")) as f:
        f.name = "OZON_—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π_–æ—Ç—á–µ—Ç.txt"
        await update.message.reply_document(document=InputFile(f), caption="üßæ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç üìä")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("üìé –ü—Ä–∏—à–ª–∏ Excel-—Ñ–∞–π–ª –æ—Ç Ozon ‚Äî —è –≤–µ—Ä–Ω—É —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π.")

async def main():
    import nest_asyncio
    import asyncio
    nest_asyncio.apply()
    app = ApplicationBuilder().token(os.getenv("BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Document.MimeType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"), handle_file))
    await app.run_polling()

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
